name: CI/CD

on:
  push:
    branches: ["main"]
    tags:
      - "constructor-v*"
  pull_request:
    branches: ["main"]

jobs:
  # Detect which packages changed
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      constructor: ${{ steps.filter.outputs.constructor }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            constructor:
              - 'packages/constructor/**'

  # Build and test constructor package
  constructor:
    name: Constructor - Build & Test
    needs: changes
    if: ${{ needs.changes.outputs.constructor == 'true' || startsWith(github.ref, 'refs/tags/constructor-v') }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: packages/constructor

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        working-directory: .
        run: uv sync --all-groups

      - name: Lint (Ruff)
        run: uv run ruff check .

      - name: Run tests
        run: uv run pytest

      - name: Sync Project Version
        run: |
          if [[ "$GITHUB_REF" == refs/tags/constructor-v* ]]; then
            VERSION=${GITHUB_REF_NAME#constructor-v}
            echo "Type: Tagged Release"
          else
            LAST_TAG=$(git tag -l 'constructor-v*' --sort=-v:refname | head -n1 || echo "constructor-v0.0.0")
            VERSION="${LAST_TAG#constructor-v}-dev"
            echo "Type: Dev Build (Last tag: $LAST_TAG)"
          fi

          echo "Syncing pyproject.toml to version: $VERSION"
          uv version "$VERSION"
          uv version

      - name: Build package
        working-directory: .
        run: uv build --package scp-constructor

      - name: Upload Build Artifact
        if: startsWith(github.ref, 'refs/tags/constructor-v')
        uses: actions/upload-artifact@v4
        with:
          name: constructor-dist
          path: dist/*
          retention-days: 1

  # Publish constructor to PyPI on tag
  publish-constructor:
    name: Constructor - Publish
    needs: constructor
    if: startsWith(github.ref, 'refs/tags/constructor-v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: constructor-dist
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*
          generate_release_notes: true

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/

